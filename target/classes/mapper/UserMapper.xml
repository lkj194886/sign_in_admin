<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sign_in.code.mapper.UserMapper">
    <resultMap id="UserResultMap" type="com.sign_in.code.entity.SignInUser">
        <id column="user_id" jdbcType="INTEGER" property="userId"/>
        <result column="user_name" jdbcType="VARCHAR" property="userName"/>
        <result column="user_vip_id" property="userVipId"/>
        <result column="user_remaining_sum" property="userRemainingSum"/>
        <result column="user_qibi" property="userQiBi"/>
        <result column="user_invitation_id" property="userInvitationId"/>
        <result column="user_invitation_code" jdbcType="VARCHAR" property="userInvitationCode"/>
        <result column="user_zhifubao" property="userZhiFUBao"/>
        <result column="user_zhifubao_name" property="userZhiFUBaoName"/>
        <result column="user_weixin" property="userWeiXin"/>
        <result column="user_weixin_name" property="userWeiXinName"/>
        <result column="user_partner_id" property="userPartnerId"/>
        <result column="user_time" property="userTime"/>
        <association property="signInVip" resultMap="VipResultMap"/>
    </resultMap>


    <resultMap id="VipResultMap" type="com.sign_in.code.entity.SignInVip">
        <id column="vip_id" property="vipId"/>
        <result column="vip_name" property="vipName"/>
        <result column="vip_exchange_rate" property="vipExchangeRate"/>
    </resultMap>

    <sql id="Base_Column_List">
        user_id,
        user_name,
        user_vip_id,
        user_remaining_sum,
        user_qibi,
        user_invitation_id,
        user_invitation_code,
        user_zhifubao,
        user_zhifubao_name,
        user_weixin,
        user_partner_id,
        user_weixin_name,
        user_time
    </sql>

    <sql id="Base_Vip_List">
        vip_id,
        vip_name,
        vip_exchange_rate
    </sql>

    <insert id="addUser">
    INSERT INTO
    `sign_in_user`
    (
    `user_name`,
    `user_vip_id`,
    `user_remaining_sum`,
    `user_qibi`,
    `user_invitation_id`,
    `user_invitation_code`,
    `user_time`
    )
    VALUES
	(
	#{userName},
	#{userVipId},
	#{userRemainingSum},
	#{userQiBi},
	#{userInvitationId},
	#{userInvitationCode}
	,NOW())
    </insert>

    <update id="boundWeiXin">

        UPDATE sign_in_user
        <trim prefix="set" suffixOverrides=",">
            <if test="userWeiXin != null and userWeiXin != '' ">
                user_weixin = #{userWeiXin},
            </if>
            <if test="userWeiXinName != null and userWeiXinName != '' ">
                user_weixin_name = #{userWeiXinName},
            </if>
        </trim>
        WHERE user_id = #{uid}
    </update>

    <update id="boundZhiFuBao">
        UPDATE sign_in_user
        <trim prefix="set" suffixOverrides=",">
            <if test="userZhiFUBao != null and userZhiFUBao != '' ">
                user_zhifubao = #{userZhiFUBao},
            </if>
            <if test="userZhiFUBaoName != null and userZhiFUBaoName != '' ">
                user_zhifubao_name = #{userZhiFUBaoName},
            </if>
        </trim>
        WHERE user_id = #{uid}
    </update>
    <update id="cumulativeProps">
        UPDATE
        sign_in_user
        <trim prefix="set" suffixOverrides=",">
            <if test="qiBi != null">
                user_qibi = #{qiBi},
            </if>
        </trim>
        WHERE user_id=#{uid}
    </update>
    <update id="qiBiWithdrawal">
        UPDATE sign_in_user
        <trim prefix="set" suffixOverrides=",">
            <if test="balance != null">
                user_remaining_sum = #{balance},
            </if>
            <if test="qiBi != null ">
                user_qibi = #{qiBi},
            </if>
        </trim>
        WHERE user_name = #{userPhone}
    </update>
    <update id="balanceWithdrawal">
        UPDATE sign_in_user
        <trim prefix="set" suffixOverrides=",">
            <if test="balance != null">
                user_remaining_sum = #{balance},
            </if>
        </trim>
        WHERE user_id=#{uid}
    </update>

    <update id="UpdateUser">
        UPDATE
        sign_in_user
        <trim prefix="set" suffixOverrides=",">
            <if test="userRemainingSum != null">
                user_remaining_sum = #{userRemainingSum},
            </if>
            <if test="userQiBi != null">
                user_qibi = #{userQiBi},
            </if>
            <if test="userWeiXinName != null and userWeiXinName != '' and userWeiXinName != 'undefined' ">
                user_weixin_name = #{userWeiXinName},
            </if>
            <if test="userWeiXin != null and userWeiXin !='' and userWeiXin != 'undefined' ">
                user_weixin = #{userWeiXin},
            </if>
            <if test="userZhiFUBaoName != null and userZhiFUBaoName != '' and userZhiFUBaoName != 'undefined' ">
                user_zhifubao_name = #{userZhiFUBaoName},
            </if>
            <if test="userZhiFUBao != null and userZhiFUBao != '' and userZhiFUBao != 'undefined' ">
                user_zhifubao = ${userZhiFUBao},
            </if>
            <if test="userVipId != 0">
                user_vip_id = #{userVipId}
            </if>
        </trim>
        WHERE user_id = #{userId}
    </update>


    <select id="getUser" resultMap="UserResultMap">
        SELECT
        <include refid="Base_Column_List"/>,
        <include refid="Base_Vip_List"/>
        FROM
        sign_in_user su
        INNER JOIN sign_in_vip sv ON sv.vip_id=su.user_vip_id
        WHERE
        su.user_name = #{phone}
    </select>
    <select id="getUserId" resultMap="UserResultMap">
        SELECT
        <include refid="Base_Column_List"/>,
        <include refid="Base_Vip_List"/>
        FROM
        sign_in_user su
        INNER JOIN sign_in_vip sv ON sv.vip_id=su.user_vip_id
        WHERE
        su.user_id = #{userInvitationId}
    </select>

    <select id="getInvitationProgress" resultMap="UserResultMap" parameterType="long">
        select  u.user_name,u.user_id,v.vip_name,u.user_invitation_code,v.*
        from sign_in_user as u
        INNER JOIN  sign_in_vip as v  ON  v.vip_id = u.user_vip_id
        where u.user_invitation_id = #{invitationCodeId}
    </select>


    <select id="getUserInvitationId" resultType="long" parameterType="string">
        SELECT
          user_id
        FROM
          sign_in_user
        WHERE
          user_name = #{phone}
    </select>
    <select id="existCode" resultType="java.lang.String">
        SELECT
         user_invitation_code
        FROM
        sign_in_user
        WHERE
         user_invitation_code=#{invitationCode}
    </select>
    <select id="getUid" resultType="java.lang.Long">
        SELECT
         user_id
        FROM
        sign_in_user
        WHERE
         user_invitation_code=#{invitationCode}
    </select>
    <select id="getUserList" resultMap="UserResultMap">
        SELECT
        <include refid="Base_Column_List"/>,
        <include refid="Base_Vip_List"/>
        FROM
        sign_in_user su
        INNER JOIN sign_in_vip sv ON sv.vip_id=su.user_vip_id
        <if test="userName != null and userName != '' ">
            WHERE user_name like CONCAT('%',#{userName},'%')
        </if>
    </select>


</mapper>